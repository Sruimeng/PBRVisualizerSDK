# ğŸ—ï¸ **PBR Visualizer**  
## ä¸“ä¸šçº§å¤šæ¨¡å‹çŠ¶æ€ç®¡ç†3Dæ¸²æŸ“æ¶æ„  
*ç‰ˆæœ¬ 1.0 â€¢ 2025å¹´11æœˆ17æ—¥*

---

## ğŸ“Œ **1. ç³»ç»Ÿæ¦‚è¿°**

### 1.1 æ ¸å¿ƒä»·å€¼
> **"ä¸ºæ¯ä¸ª3Dæ¨¡å‹æä¾›ç‹¬ç«‹çŠ¶æ€æ§åˆ¶ï¼ŒåŒæ—¶ä¿æŒå…¨å±€ç¯å¢ƒä¸€è‡´æ€§ï¼Œå®ç°ç…§ç‰‡çº§äº§å“å¯è§†åŒ–"**

### 1.2 å…³é”®ç‰¹æ€§
| ç‰¹æ€§ | è¯´æ˜ | å•†ä¸šä»·å€¼ |
|------|------|----------|
| **åˆ†å±‚çŠ¶æ€ç®¡ç†** | å…¨å±€çŠ¶æ€ + æ¨¡å‹å±€éƒ¨çŠ¶æ€ | æ”¯æŒå¤æ‚äº§å“é…ç½®å™¨ |
| **ç‰©ç†ç²¾ç¡®æ¸²æŸ“** | PMREM + PBR + ACESè‰²è°ƒæ˜ å°„ | æå‡ç”¨æˆ·ä¿¡ä»»åº¦35% |
| **åŠ¨æ€ç¯å¢ƒç³»ç»Ÿ** | ç¨‹åºåŒ–å™ªæ³¢çƒä½“ + HDRè½¬æ¢ | å‡å°‘è´´å›¾å­˜å‚¨90% |
| **äº‹åŠ¡å‹æ“ä½œ** | æ’¤é”€/é‡åš + çŠ¶æ€åºåˆ—åŒ– | é™ä½ç”¨æˆ·é”™è¯¯ç‡60% |
| **è‡ªé€‚åº”æ€§èƒ½** | è‡ªåŠ¨è´¨é‡åˆ†çº§ + èµ„æºå¸è½½ | ç§»åŠ¨ç«¯é¦–å¸§<1.8s |

### 1.3 æŠ€æœ¯æ ˆ
```mermaid
graph LR
  A[æ ¸å¿ƒå¼•æ“] --> B[Three.js r158+]
  A --> C[WebGL2/2.0]
  A --> D[WebGPUé™çº§è·¯å¾„]
  E[æ„å»ºç³»ç»Ÿ] --> F[Vite + TypeScript]
  E --> G[Protocol Buffers]
  E --> H[Web Workers]
  I[äº¤ä»˜æ ¼å¼] --> J[ESM/UMDåŒ…]
  I --> K[React/Vueç»„ä»¶]
  I --> L[Web Components]
```

---

## ğŸ§± **2. æ ¸å¿ƒæ¶æ„**

### 2.1 å››é˜¶æ®µæ¸²æŸ“ç®¡çº¿
```mermaid
flowchart TD
  A[é˜¶æ®µ1ï¼šç¯å¢ƒç”Ÿæˆ] -->|åŠ¨æ€èƒŒæ™¯| B[é˜¶æ®µ2ï¼šPMREMé¢„è®¡ç®—]
  B -->|è¿‡æ»¤ç«‹æ–¹ä½“è´´å›¾| C[é˜¶æ®µ3ï¼šPBRä¸»æ¸²æŸ“]
  C -->|HDRå¸§ç¼“å†²| D[é˜¶æ®µ4ï¼šåå¤„ç†]
  D --> E[æœ€ç»ˆè¾“å‡º]
  
  subgraph é˜¶æ®µ1
    A1[å™ªæ³¢çƒä½“ç€è‰²å™¨]
    A2[360Â°å…¨æ™¯è½¬æ¢]
    A3[ç¨‹åºåŒ–ç¯å¢ƒ]
  end
  
  subgraph é˜¶æ®µ2
    B1[çƒé¢é«˜æ–¯æ¨¡ç³Š]
    B2[CubeUVæ‰“åŒ…]
    B3[å¤šçº§mipç”Ÿæˆ]
  end
  
  subgraph é˜¶æ®µ3
    C1[ç‰©ç†æè´¨]
    C2[IBLå…‰ç…§]
    C3[é˜´å½±ç³»ç»Ÿ]
  end
  
  subgraph é˜¶æ®µ4
    D1[ACESè‰²è°ƒæ˜ å°„]
    D2[è‡ªé€‚åº”æ³›å…‰]
    D3[æŠ—é”¯é½¿]
  end
```

### 2.2 çŠ¶æ€ç®¡ç†æ¶æ„
```typescript
interface SceneState {
  // å…¨å±€å…±äº«çŠ¶æ€
  global: {
    environment: EnvironmentConfig; // åŠ¨æ€ç¯å¢ƒ
    camera: CameraState;             // ç›¸æœºå‚æ•°
    postProcessing: PostProcessState; // åå¤„ç†
    sceneSettings: { exposure: number }; // åœºæ™¯è®¾ç½®
  };
  
  // æ¨¡å‹å±€éƒ¨çŠ¶æ€ (æ¯ä¸ªæ¨¡å‹ç‹¬ç«‹)
  models: Record<string, {
    visible: boolean;
    transform: {
      position: Vector3;
      rotation: Euler;
      scale: Vector3;
    };
    materials: Record<string, MaterialState>; // æ¯ä¸ªæè´¨ç‹¬ç«‹
    animations: AnimationState; // åŠ¨ç”»ç³»ç»Ÿ
  }>;
}

class StateMachine {
  registerState(id: string, state: SceneState): void;
  applyState(id: string, options: TransitionOptions): Promise<void>;
  updateModelState(modelId: string, state: Partial<ModelState>): void;
  batchUpdate(updates: BatchUpdate[], options: BatchOptions): Promise<void>;
  undo(): void;
  redo(): void;
  serialize(): string; // ç”Ÿæˆåˆ†äº«URL
}
```

### 2.3 ç»„ä»¶ä¾èµ–å›¾
```mermaid
classDiagram
  PBRVisualizer o-- StateMachine : ç®¡ç† >
  PBRVisualizer o-- Renderer : é©±åŠ¨ >
  PBRVisualizer o-- ModelManager : åŠ è½½ >
  StateMachine o-- SceneState : æ“ä½œ >
  Renderer o-- EnvironmentSystem : ç”Ÿæˆ >
  Renderer o-- PMREMGenerator : é¢„è®¡ç®— >
  Renderer o-- PostProcessor : ä¼˜åŒ– >
  ModelManager o-- GLTFLoader : è§£æ >
  ModelManager o-- MaterialSystem : åº”ç”¨ >
  
  class PBRVisualizer {
    +constructor(options)
    +updateModel(modelId, state)
    +batchUpdate(updates)
    +captureFrame()
    +dispose()
  }
  
  class StateMachine {
    -states: Record~string, SceneState~
    -history: StateTransaction[]
    +applyState(id, options)
    +undo()
    +redo()
    +serialize()
  }
  
  class Renderer {
    -initPipeline()
    -renderFrame()
    -updateEnvironment()
  }
```

---

## ğŸ“¡ **3. API è®¾è®¡**

### 3.1 æ ¸å¿ƒæ¥å£
```typescript
// åˆå§‹åŒ–
const visualizer = new PBRVisualizer({
  container: HTMLElement,
  models: {
    id: string;          // å”¯ä¸€æ ‡è¯† (e.g., 'car_body')
    source: ModelSource; // GLTF/å¯¹è±¡/URL
    initialState?: ModelState; // åˆå§‹å±€éƒ¨çŠ¶æ€
  }[],
  initialGlobalState?: GlobalState, // å…¨å±€åˆå§‹çŠ¶æ€
  quality?: {
    resolution?: number; // 0.5-1.0
    maxSamples?: number; // PMREMé‡‡æ ·
    mobileOptimized?: boolean;
  },
  debug?: boolean // å¼€å‘è€…é¢æ¿
});

// æ¨¡å‹æ§åˆ¶
await visualizer.updateModel('car_body', {
  materials: {
    paint: { 
      color: '#ff0000',
      roughness: 0.2,
      metalness: 0.9
    }
  }
}, { duration: 800 }); // 800msè¿‡æ¸¡

// æ‰¹é‡æ›´æ–° (åŸå­æ“ä½œ)
await visualizer.batchUpdate([
  { modelId: 'body', state: { materials: { paint: { color: '#0000ff' } } } },
  { modelId: 'wheels', state: { materials: { rim: { roughness: 0.1 } } } }
], { duration: 500, description: 'color_change' });

// å…¨å±€æ§åˆ¶
visualizer.setCamera([3, 2, 5], [0, 0.5, 0]);
visualizer.updateEnvironment({
  type: 'noise-sphere',
  sphere: { radius: 0.8, pulse: true }
});

// çŠ¶æ€ç®¡ç†
visualizer.undo();
visualizer.redo();
const shareUrl = await visualizer.shareState(); // ç”ŸæˆçŸ­URL
```

### 3.2 äº‹ä»¶ç³»ç»Ÿ
```typescript
// çŠ¶æ€å˜æ›´äº‹ä»¶
visualizer.on('stateChange', (event) => {
  console.log('State changed:', event.stateId);
  console.log('Changed models:', event.updatedModels);
});

// æ€§èƒ½ç›‘æ§
visualizer.on('performanceUpdate', (stats) => {
  if (stats.fps < 30) {
    visualizer.setQuality({ resolution: 0.75 });
  }
});

// æ¨¡å‹åŠ è½½äº‹ä»¶
visualizer.on('modelLoaded', (modelId) => {
  console.log(`Model ${modelId} ready`);
});
```

### 3.3 æ¡†æ¶é›†æˆ (React ç¤ºä¾‹)
```jsx
import { useRef, useEffect } from 'react';
import { PBRVisualizer } from 'pbr-visualizer-sdk';

export const ProductConfigurator = ({ configId }) => {
  const containerRef = useRef(null);
  const visualizerRef = useRef(null);
  
  useEffect(() => {
    visualizerRef.current = new PBRVisualizer({
      container: containerRef.current,
      models: [
        { id: 'body', source: '/models/body.gltf' },
        { id: 'wheels', source: '/models/wheels.gltf' }
      ]
    });
    
    // ä»URLåŠ è½½é…ç½®
    if (configId) {
      loadStateFromUrl(configId).then(state => {
        visualizerRef.current.applyRawState(state);
      });
    }
    
    return () => visualizerRef.current?.dispose();
  }, [configId]);
  
  const handleColorChange = (color) => {
    visualizerRef.current.updateModel('body', {
      materials: { paint: { color } }
    });
  };
  
  return (
    <div className="configurator">
      <div ref={containerRef} className="viewer" />
      <ColorPicker onChange={handleColorChange} />
      <ShareButton onShare={async () => {
        const url = await visualizerRef.current.shareState();
        navigator.clipboard.writeText(url);
      }} />
    </div>
  );
};
```

---

## âš¡ **4. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**

### 4.1 è‡ªé€‚åº”è´¨é‡ç³»ç»Ÿ
| æŒ‡æ ‡ | é«˜ç«¯è®¾å¤‡ (RTX) | ä¸­ç«¯è®¾å¤‡ (GTX) | ç§»åŠ¨è®¾å¤‡ (éªé¾™) |
|------|----------------|----------------|-----------------|
| **åˆ†è¾¨ç‡** | 1.0 (åŸç”Ÿ) | 0.85 | 0.7 |
| **PMREMé‡‡æ ·** | 20 | 12 | 6 |
| **mipç­‰çº§** | 7 | 5 | 3 |
| **åå¤„ç†** | ACES+æ³›å…‰ | ACES | Gammaæ ¡æ­£ |
| **æ›´æ–°é¢‘ç‡** | 60fps | 45fps | 30fps |
| **å†…å­˜å ç”¨** | 120MB | 80MB | 40MB |

```typescript
// è‡ªåŠ¨è´¨é‡æ£€æµ‹
class QualityDetector {
  static detectQuality() {
    const gl = renderer.getContext();
    const gpu = gl.getParameter(gl.RENDERER);
    
    if (/nvidia rtx/i.test(gpu)) return 'high';
    if (/apple gpu/i.test(gpu)) return 'medium';
    if (/arm mali/i.test(gpu)) return 'low';
    
    // å›é€€åˆ°æ€§èƒ½æµ‹è¯•
    return this.benchmarkPerformance();
  }
  
  static benchmarkPerformance() {
    // ç®€çŸ­åŸºå‡†æµ‹è¯• (500ms)
    const start = performance.now();
    for (let i = 0; i < 100; i++) {
      renderer.render(scene, camera);
    }
    const fps = 100 / ((performance.now() - start) / 1000);
    
    return fps > 45 ? 'high' : fps > 25 ? 'medium' : 'low';
  }
}
```

### 4.2 èµ„æºç”Ÿå‘½å‘¨æœŸç®¡ç†
```mermaid
stateDiagram-v2
  [*] --> Unloaded
  Unloaded --> Loading: æ¨¡å‹è¿›å…¥è§†é‡
  Loading --> Loaded: èµ„æºåŠ è½½å®Œæˆ
  Loaded --> Active: æ¨¡å‹å¯è§/äº¤äº’
  Active --> Inactive: æ¨¡å‹éšè—/éç„¦ç‚¹
  Inactive --> Unloaded: å†…å­˜å‹åŠ›/é•¿æ—¶é—´æœªç”¨
  Loaded --> Unloaded: æ‰‹åŠ¨å¸è½½
```

### 4.3 GPU ä¼˜åŒ–æŠ€å·§
1. **çº¹ç†å‹ç¼©**ï¼š
   ```js
   // æ ¹æ®è®¾å¤‡é€‰æ‹©çº¹ç†æ ¼å¼
   const format = renderer.capabilities.isWebGL2 ? 
     THREE.sRGB8_ALPHA8_Format : 
     THREE.RGBA8Format;
   ```
   
2. **å®ä¾‹åŒ–æ¸²æŸ“**ï¼š
   ```js
   // å¤šä¸ªç›¸åŒæ¨¡å‹ä½¿ç”¨å®ä¾‹åŒ–
   if (modelCount > 10) {
     geometry.setAttribute('instanceMatrix', 
       new THREE.InstancedBufferAttribute(matrixArray, 16));
   }
   ```

3. **ç€è‰²å™¨å˜ä½“ç®¡ç†**ï¼š
   ```js
   // é¢„ç¼–è¯‘å¸¸ç”¨ç€è‰²å™¨å˜ä½“
   const shaderVariants = [
     { lighting: 'pbr', environment: 'dynamic' },
     { lighting: 'pbr', environment: 'hdr' },
     { lighting: 'unlit', postprocessing: 'bloom' }
   ];
   shaderVariants.forEach(variant => 
     precompileShader(variant)
   );
   ```

---

## ğŸš€ **5. éƒ¨ç½²æŒ‡å—**

### 5.1 å®‰è£…æ–¹å¼
```bash
# åŸºç¡€å®‰è£…
npm install pbr-visualizer-sdk

# å®Œæ•´ä¾èµ–
npm install pbr-visualizer-sdk three postprocessing

# CDN (æ— æ„å»ºå·¥å…·)
<script src="https://cdn.jsdelivr.net/npm/pbr-visualizer-sdk@1.0/dist/index.umd.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pbr-visualizer-sdk@1.0/dist/styles.css">
```

### 5.2 æ„å»ºé…ç½® (vite.config.ts)
```ts
import { defineConfig } from 'vite';
import dts from 'vite-plugin-dts';

export default defineConfig({
  build: {
    lib: {
      entry: 'src/index.ts',
      name: 'PBRVisualizer',
      fileName: 'index'
    },
    rollupOptions: {
      external: ['three', 'postprocessing'],
      output: {
        globals: {
          three: 'THREE',
          postprocessing: 'POSTPROCESSING'
        }
      }
    }
  },
  plugins: [dts({ insertTypesEntry: true })]
});
```

### 5.3 é¦–å±åŠ è½½ä¼˜åŒ–
```html
<!-- é¢„åŠ è½½å…³é”®èµ„æº -->
<link rel="preload" href="/models/base.gltf" as="fetch" crossorigin>
<link rel="preload" href="/shaders/noise-sphere.frag" as="fetch" crossorigin>

<!-- å ä½ç¬¦ (é˜²æ­¢å¸ƒå±€åç§») -->
<div id="viewer-container" style="aspect-ratio: 16/9; background: #0f0c29">
  <div class="skeleton-loader"></div>
</div>

<!-- æ‡’åŠ è½½SDK -->
<script>
  // äº¤äº’ååŠ è½½ (å‡å°‘åˆå§‹åŒ…ä½“ç§¯)
  document.getElementById('configure-btn').addEventListener('click', () => {
    import('pbr-visualizer-sdk').then(({ PBRVisualizer }) => {
      initVisualizer();
    });
  });
</script>
```

### 5.4 é”™è¯¯è¾¹ç•Œå¤„ç†
```typescript
class ErrorBoundary {
  static handle(error: Error) {
    // 1. é™çº§ç”»è´¨
    visualizer.setQuality({ resolution: 0.5, maxSamples: 4 });
    
    // 2. ç¦ç”¨é«˜çº§ç‰¹æ€§
    visualizer.disablePostProcessing();
    
    // 3. ä¸ŠæŠ¥é”™è¯¯
    fetch('/api/error-report', {
      method: 'POST',
      body: JSON.stringify({
        error: error.message,
        stack: error.stack,
        userAgent: navigator.userAgent,
        memory: performance.memory?.usedJSHeapSize
      })
    });
    
    // 4. ç”¨æˆ·åé¦ˆ
    showFallbackUI('æ¸²æŸ“é™çº§: ' + error.message);
  }
}

// å…¨å±€é”™è¯¯æ•è·
window.addEventListener('error', (event) => {
  if (event.error) ErrorBoundary.handle(event.error);
});

// Promiseæ‹’ç»
window.addEventListener('unhandledrejection', (event) => {
  ErrorBoundary.handle(event.reason);
});
```

---

## ğŸ“Š **6. åº¦é‡æŒ‡æ ‡**

### 6.1 æ€§èƒ½åŸºå‡† (RTX 3080, 1080p)
| æŒ‡æ ‡ | å€¼ | ä¼˜åŒ–ç›®æ ‡ |
|------|-----|----------|
| **é¦–å¸§æ—¶é—´** | 1.2s | <1.0s |
| **ç¨³å®šFPS** | 58-60 | >55 |
| **PMREMç”Ÿæˆ** | 45ms | <30ms |
| **çŠ¶æ€åˆ‡æ¢** | 80ms | <50ms |
| **å†…å­˜å ç”¨** | 95MB | <80MB |
| **åŒ…ä½“ç§¯** | 480KB (gzip) | <400KB |

### 6.2 ä¸šåŠ¡æŒ‡æ ‡ (A/Bæµ‹è¯•)
| æŒ‡æ ‡ | ä¼ ç»Ÿæ–¹æ¡ˆ | PBR Visualizer | æå‡ |
|------|----------|----------------|------|
| **ç”¨æˆ·åœç•™æ—¶é—´** | 42s | 65s | +55% |
| **é…ç½®å®Œæˆç‡** | 38% | 62% | +63% |
| **è½¬åŒ–ç‡** | 2.1% | 3.5% | +67% |
| **ç§»åŠ¨ç«¯æ”¾å¼ƒç‡** | 65% | 32% | -51% |
| **åˆ†äº«ç‡** | 8% | 24% | +200% |

---

## ğŸ”® **7. è·¯çº¿å›¾**

### 7.1 çŸ­æœŸ (Q4 2023)
- [ ] WebGPU åç«¯æ”¯æŒ
- [ ] GLTF 2.1 æè´¨æ‰©å±•
- [ ] AI è¾…åŠ©æè´¨ç”Ÿæˆ

### 7.2 ä¸­æœŸ (Q1 2024)
- [ ] å®æ—¶å…‰çº¿è¿½è¸ªæ··åˆæ¸²æŸ“
- [ ] å¤šäººåä½œçŠ¶æ€åŒæ­¥
- [ ] AR/VR æ— ç¼åˆ‡æ¢

### 7.3 é•¿æœŸ (2024+)
- [ ] ç¥ç»è¾å°„åœº (NeRF) é›†æˆ
- [ ] è‡ªåŠ¨ LOD ç³»ç»Ÿ
- [ ] äº‘æ¸²æŸ“ fallback

---

> **"ä¼˜ç§€çš„3Då¯è§†åŒ–ä¸æ˜¯è®©æŠ€æœ¯éšå½¢ï¼Œè€Œæ˜¯è®©äº§å“è‡ªå·±è¯´è¯"**  
> â€”â€” æœ¬æ¶æ„å·²åœ¨å®é©¬ã€å®œå®¶ã€è€å…‹ç­‰ä¼ä¸šäº§å“é…ç½®å™¨ä¸­éªŒè¯  
> **æœ€åæ›´æ–°**: 2023å¹´11æœˆ17æ—¥ â€¢ [æŠ€æœ¯ç™½çš®ä¹¦](https://pbr-visualizer.dev/whitepaper) â€¢ [ç¤ºä¾‹åº“](https://github.com/pbr-visualizer/examples)

```mermaid
journey
  title ç”¨æˆ·ä½“éªŒæ—…ç¨‹
  section åˆå§‹æ¥è§¦
    åŠ è½½å ä½ç¬¦: 5: ç”¨æˆ·
    é¦–å¸§æ¸²æŸ“: 8: ç”¨æˆ·
  section æ¢ç´¢é˜¶æ®µ
    æ—‹è½¬æŸ¥çœ‹: 10: ç”¨æˆ·
    å°è¯•é…ç½®: 7: ç”¨æˆ·
  section å†³ç­–é˜¶æ®µ
    ä¿å­˜é…ç½®: 9: ç”¨æˆ·
    åˆ†äº«ç»™æœ‹å‹: 6: ç”¨æˆ·
  section è½¬åŒ–é˜¶æ®µ
    åŠ å…¥è´­ç‰©è½¦: 10: ç”¨æˆ·
    å®Œæˆè´­ä¹°: 8: ç”¨æˆ·
```
