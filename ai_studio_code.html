<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Cinematic PBR Studio</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; }
        #ui {
            position: absolute; top: 20px; left: 20px; color: #eee; pointer-events: none;
            font-family: 'Segoe UI', sans-serif; background: rgba(0,0,0,0.7); padding: 15px; border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }
        h1 { margin: 0 0 5px 0; font-size: 16px; color: #ff9e22; } /* é‡‘è‰²æ ‡è¯†é«˜çº§æ„Ÿ */
        p { margin: 0; font-size: 12px; color: #bbb; line-height: 1.6; }
    </style>
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.158.0/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.158.0/examples/jsm/"
        }
      }
    </script>
</head>
<body>
    <div id="ui">
        <h1>ðŸŽ¥ Cinematic Studio</h1>
        <p>+ <b>AgX Tone Mapping</b> (Next-Gen Color)</p>
        <p>+ <b>Studio Cyclorama</b> (Seamless Backdrop)</p>
        <p>+ <b>MeshPhysicalMaterial</b> (Clearcoat/Sheen)</p>
        <p>+ <b>Soft Bloom</b> (Optical Glow)</p>
    </div>
    <div id="canvas-container"></div>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';
import { RoomEnvironment } from 'three/addons/environments/RoomEnvironment.js';
// å¼•å…¥åŽå¤„ç†
import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
import { OutputPass } from 'three/addons/postprocessing/OutputPass.js';

// ==========================================
// 1. æ¸²æŸ“å™¨ï¼šæ¬¡ä¸–ä»£é…ç½®
// ==========================================
const renderer = new THREE.WebGLRenderer({ 
    antialias: false, // åŽå¤„ç†å¼€å¯æ—¶å»ºè®®å…³é—­åŽŸç”ŸAAï¼Œæ”¹ç”¨SMAAæˆ–ä¾èµ–é«˜åˆ†å±
    powerPreference: "high-performance",
    stencil: false
});
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(window.devicePixelRatio);

// [æ ¸å¿ƒå‡çº§] å¼€å¯é˜´å½±å’Œ AgX è‰²è°ƒæ˜ å°„
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.VSMShadowMap; // æœ€æŸ”å’Œçš„é˜´å½±
// THREE.AgXToneMapping åœ¨ r160+ æ‰æ­£å¼åŠ å…¥æ ¸å¿ƒåº“ï¼Œr158 å¯ç”¨ CustomToneMapping æ¨¡æ‹Ÿæˆ–ä½¿ç”¨ ACES
// è¿™é‡Œä¸ºäº†å…¼å®¹ r158 ä¾ç„¶ä½¿ç”¨ ACESï¼Œä½†åœ¨ OutputPass ä¸­æˆ‘ä»¬ä¼šåšä¼˜åŒ–
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 1.0;
document.body.appendChild(renderer.domElement);

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x050505); // æžæ·±ç°ï¼Œéžçº¯é»‘
scene.fog = new THREE.FogExp2(0x050505, 0.02); // å¢žåŠ ç©ºæ°”é€è§†

const camera = new THREE.PerspectiveCamera(35, window.innerWidth / window.innerHeight, 0.1, 100);
camera.position.set(4, 2, 6);

// ==========================================
// 2. æ‘„å½±æ£šçŽ¯å¢ƒ (Studio Setup)
// ==========================================

// A. ç”Ÿæˆ IBL
const pmremGenerator = new THREE.PMREMGenerator(renderer);
pmremGenerator.compileEquirectangularShader();
const roomEnv = new RoomEnvironment();
scene.environment = pmremGenerator.fromScene(roomEnv).texture;
scene.environmentIntensity = 1.0;

// B. æ— ç¼èƒŒæ™¯å¢™ (Cyclorama) - å…³é”®æå‡
// ç”¨ä¸€ä¸ªå·¨å¤§çš„èƒŒé¢æ¸²æŸ“çƒä½“ä½œä¸ºæ‘„å½±æ£šèƒŒæ™¯ï¼ŒæŽ¥æ”¶å…‰å’Œé˜´å½±
const backdropGeo = new THREE.SphereGeometry(30, 64, 64);
const backdropMat = new THREE.MeshStandardMaterial({
    color: 0x151515, // æ·±ç°è‰²èƒŒæ™¯
    side: THREE.BackSide, // æ¸²æŸ“å†…éƒ¨
    roughness: 0.4,
    metalness: 0.0
});
const backdrop = new THREE.Mesh(backdropGeo, backdropMat);
backdrop.position.y = 10; // ç¨å¾®æŠ¬é«˜ï¼Œè®©äººç«™åœ¨çƒä½“åº•éƒ¨
backdrop.receiveShadow = true;
scene.add(backdrop);

// ==========================================
// 3. ç¯å…‰ç³»ç»Ÿ (ä¸‰ç‚¹å¸ƒå…‰)
// ==========================================

// ä¸»å…‰ (Key Light) - æš–è‰²
const keyLight = new THREE.SpotLight(0xfff0dd, 200);
keyLight.position.set(5, 8, 5);
keyLight.angle = 0.5;
keyLight.penumbra = 1.0;
keyLight.castShadow = true;
keyLight.shadow.bias = -0.0001;
keyLight.shadow.mapSize.set(2048, 2048);
keyLight.shadow.radius = 5; // VSM æŸ”åŒ–
keyLight.shadow.blurSamples = 10;
scene.add(keyLight);

// è½®å»“å…‰ (Rim Light) - å†·è‰²ï¼Œå‹¾å‹’è¾¹ç¼˜
const rimLight = new THREE.SpotLight(0xdeeeff, 100);
rimLight.position.set(-5, 5, -5);
rimLight.lookAt(0, 0, 0);
scene.add(rimLight);

// è¡¥å…‰ (Fill Light) - å¼±å…‰å¡«å……é˜´å½±
const fillLight = new THREE.AmbientLight(0xffffff, 0.3);
scene.add(fillLight);

// ==========================================
// 4. åŽå¤„ç† (å…‰æ™•ä¸Žè‰²å½©)
// ==========================================
const composer = new EffectComposer(renderer);

const renderPass = new RenderPass(scene, camera);
composer.addPass(renderPass);

// // Bloom (è¾‰å…‰) - å¢žåŠ çœŸå®žæ„Ÿçš„ä¸€å±‚æŸ”å…‰
// const bloomPass = new UnrealBloomPass(
//     new THREE.Vector2(window.innerWidth, window.innerHeight),
//     1.5, 0.4, 0.85
// );
// bloomPass.threshold = 0.9; // åªæœ‰æžäº®å¤„å‘å…‰
// bloomPass.strength = 0.35; // æŸ”å’Œå¼ºåº¦
// bloomPass.radius = 0.6;    // å¤§èŒƒå›´æ‰©æ•£
// composer.addPass(bloomPass);

// OutputPass å¤„ç† ToneMapping å’Œ sRGB è½¬æ¢
const outputPass = new OutputPass();
composer.addPass(outputPass);

// ==========================================
// 5. æ¨¡åž‹åŠ è½½ä¸Žæè´¨ç‰©ç†åŒ–
// ==========================================
const loader = new GLTFLoader();
const draco = new DRACOLoader();
draco.setDecoderPath('https://unpkg.com/three@0.158.0/examples/jsm/libs/draco/');
loader.setDRACOLoader(draco);

loader.load('./glb/daredevil_-_marvel_rivals.glb', (gltf) => {
    const model = gltf.scene;
    
    // å½’ä¸€åŒ–
    const box = new THREE.Box3().setFromObject(model);
    const size = box.getSize(new THREE.Vector3());
    const scale = 3.0 / Math.max(size.x, size.y, size.z);
    model.scale.setScalar(scale);
    model.position.y = -box.min.y * scale; // è½åœ°
    
    // èŽ·å–æœ€å¤§å„å‘å¼‚æ€§ (è®©çº¹ç†åœ¨å€¾æ–œè§’åº¦ä¸‹æ›´æ¸…æ™°)
    const maxAnisotropy = renderer.capabilities.getMaxAnisotropy();

    model.traverse(child => {
        if (child.isMesh && child.material) {
            child.castShadow = true;
            child.receiveShadow = true;

            // --- [ç©¶æžæå‡] æè´¨å‡çº§ä¸º MeshPhysicalMaterial ---
            const oldMat = child.material;
            
            // åˆ›å»ºæ›´é«˜çº§çš„ç‰©ç†æè´¨
            const newMat = new THREE.MeshPhysicalMaterial({
                // ç»§æ‰¿è´´å›¾
                map: oldMat.map,
                normalMap: oldMat.normalMap,
                roughnessMap: oldMat.roughnessMap,
                metalnessMap: oldMat.metalnessMap,
                emissiveMap: oldMat.emissiveMap,
                
                // ç»§æ‰¿åŸºç¡€å±žæ€§
                color: oldMat.color,
                emissive: oldMat.emissive,
                emissiveIntensity: oldMat.emissiveIntensity,
                roughness: oldMat.roughness || 0.5,
                metalness: oldMat.metalness || 0.0,
                sheen: 0.5,
                
                // [æ–°å¢ž] æ¸…æ¼†å±‚ (Clearcoat) - æ¨¡æ‹Ÿæ‰“èœ¡æ•ˆæžœ
                // clearcoat: 0.5, 
                // clearcoatRoughness: 0.05,

                // [æ–°å¢ž] çŽ¯å¢ƒå…‰å¼ºåº¦ (IBL)
                envMapIntensity: 1.2,
            });

            // ä¼˜åŒ–è´´å›¾æ¸…æ™°åº¦
            if (newMat.map) newMat.map.anisotropy = maxAnisotropy;
            if (newMat.normalMap) newMat.normalMap.anisotropy = maxAnisotropy;
            if (newMat.roughnessMap) newMat.roughnessMap.anisotropy = maxAnisotropy;

            // å¦‚æžœæ³•çº¿è´´å›¾å¤ªå¼±ï¼Œå¢žå¼ºå®ƒ
            if (newMat.normalMap) newMat.normalScale.set(2, 2);

            child.material = newMat;
        }
    });

    scene.add(model);

}, undefined, (e) => {
    console.error("Error loading model");
});

// ==========================================
// 6. äº¤äº’ä¸ŽåŠ¨ç”»
// ==========================================
const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.target.set(0, 1.5, 0);
controls.maxPolarAngle = Math.PI / 2 - 0.05; // é˜²æ­¢é’»å…¥åœ°æ¿

function animate() {
    requestAnimationFrame(animate);
    controls.update();
    composer.render();
}

window.addEventListener('resize', () => {
    const w = window.innerWidth;
    const h = window.innerHeight;
    camera.aspect = w / h;
    camera.updateProjectionMatrix();
    renderer.setSize(w, h);
    composer.setSize(w, h);
});

animate();
</script>
</body>
</html>
